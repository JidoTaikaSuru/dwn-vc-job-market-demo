<!DOCTYPE html>
<html>
<head>
    <title>Iframe Content</title>
</head>
<body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.8.1/ethers.umd.min.js" integrity="sha512-k7vcwydSEAD9e/QV/qvviPCbOl332HGM4ttMpgC/LH0mQMfmKi22YCNo8lmJ3r4kf+5L7jgEuxzLlc5JU/pjeA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<h1>Iframe Content</h1>

<div style="flex-direction: column; max-width: 500px">
<input type="button" value="Login" onclick="createAccountSendPub()"/>
<h3>Wallet Public Key</h3>
<p id="pubkeyDisplay">(user hasn't signed in yet)</p>
<h3>Message received from parent</h3>
<p id="iframeReceiveText" style="word-wrap: anywhere">(parent hasn't sent a message yet)</p>

</div>
<div id="messageReceivedDisplay"></div>
<div id="signedMessageDisplay"></div>
<script>
    let wallet;
    createAccountSendPub = () => {
        wallet = ethers.Wallet.createRandom();
        document.getElementById("pubkeyDisplay").innerHTML = wallet.address;
        console.log("Finished loading iframe", wallet);
        parent.postMessage(JSON.stringify({messageType: "giveParentPubkey", message: wallet.address}), "http://localhost:3000");
    }


    // Receive message from parent
    window.addEventListener("message", (event) => {
        if (event.origin !== "http://localhost:3000") {
            return;
        }
        console.log("Received message from parent", event.data);
        messageReceivedDisplay.innerHTML = event.data;
        wallet.signMessage(event.data)
            .then(signedMessage => {
                signedMessageDisplay.innerHTML = signedMessage;
                console.log("Signed Message:", signedMessage);
                parent.postMessage(JSON.stringify({messageType: "signedMessage", message: signedMessage}), "http://localhost:3000");
            })
            .catch(error => {
                console.error("Error signing message:", error);
            });
        document.getElementById("iframeReceiveText").innerHTML = event.data;
    });
</script>
</body>
</html>